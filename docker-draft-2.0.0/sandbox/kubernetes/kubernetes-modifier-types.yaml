tosca_definitions_version: alien_dsl_2_0_0

metadata:
  template_name: kubernetes-modifier-types
  template_version: 2.0.0-SNAPSHOT
  template_author: alien4cloud


description: |
  Kubernetes types useful for modifiers.

imports:
  - tosca-normative-types:1.0.0-SNAPSHOT
  - docker-types:2.0.0-SNAPSHOT

data_types:

  # org.alien4cloud.extended.container.data.Deployment:
  #   derived_from: tosca.datatypes.Root
  #   description: |
  #     c.f. https://kubernetes.io/docs/api-reference/v1.6/#deployment-v1beta1-apps
  #   properties:
  #     apiVersion:
  #       type: string
  #       description: |
  #         APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#resources
  #     kind:
  #       type: string
  #       description: |
  #         Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#types-kinds
  #     metadata:
  #       type: ObjectMeta
  #       description: |
  #         Standard object metadata.
  #     spec:
  #       type: org.alien4cloud.extended.container.data.DeploymentSpec
  #       description: |
  #         Specification of the desired behavior of the Deployment

  org.alien4cloud.extended.container.data.ServicePort:
    derived_from: tosca.datatypes.Root
    description: >
      c.f. https://v1-6.docs.kubernetes.io/docs/api-reference/v1.6/#serviceport-v1-core
    properties:
      name:
        type: string
        description: |
          The name of this port within the service. This must be a DNS_LABEL. All ports within a ServiceSpec must have unique names. This maps to the 'Name' field in EndpointPort objects. Optional if only one ServicePort is defined on this service.
      nodePort:
        type: integer
        description: |
          The port on each node on which this service is exposed when type=NodePort or LoadBalancer. Usually assigned by the system. If specified, it will be allocated to the service if unused or else creation of the service will fail. Default is to auto-allocate a port if the ServiceType of this Service requires one. More info: http://kubernetes.io/docs/user-guide/services#type--nodeport
      port:
        type: integer
        description: |
          The port that will be exposed by this service.
      protocol:
        type: string
        description: |
          The IP protocol for this port. Supports "TCP" and "UDP". Default is TCP.
      targetPort:
        type: integer
        description: |
          Number or name of the port to access on the pods targeted by the service. Number must be in the range 1 to 65535. Name must be an IANA_SVC_NAME. If this is a string, it will be looked up as a named port in the target Pod's container ports. If this is not specified, the value of the 'port' field is used (an identity map). This field is ignored for services with clusterIP=None, and should be omitted or set equal to the 'port' field. More info: http://kubernetes.io/docs/user-guide/services#defining-a-service
        constraints:
          - less_or_equal: 1
          - greater_or_equal: 65535

  org.alien4cloud.extended.container.data.ServiceSpec:
    derived_from: tosca.datatypes.Root
    description: >
      c.f. https://v1-6.docs.kubernetes.io/docs/api-reference/v1.6/#servicespec-v1-core
    properties:
      clusterIP:
        type: string
        description: |
          clusterIP is the IP address of the service and is usually assigned randomly by the master. If an address is specified manually and is not in use by others, it will be allocated to the service; otherwise, creation of the service will fail. This field can not be changed through updates. Valid values are "None", empty string (""), or a valid IP address. "None" can be specified for headless services when proxying is not required. Only applies to types ClusterIP, NodePort, and LoadBalancer. Ignored if type is ExternalName. More info: http://kubernetes.io/docs/user-guide/services#virtual-ips-and-service-proxies
      deprecatedPublicIPs:
        type: string
        description: |
          array  deprecatedPublicIPs is deprecated and replaced by the externalIPs field with almost the exact same semantics. This field is retained in the v1 API for compatibility until at least 8/20/2016. It will be removed from any new API revisions. If both deprecatedPublicIPs and externalIPs are set, deprecatedPublicIPs is used.
      externalIPs:
        type: string
        description: |
          array  externalIPs is a list of IP addresses for which nodes in the cluster will also accept traffic for this service. These IPs are not managed by Kubernetes. The user is responsible for ensuring that traffic arrives at a node with this IP. A common example is external load-balancers that are not part of the Kubernetes system. A previous form of this functionality exists as the deprecatedPublicIPs field. When using this field, callers should also clear the deprecatedPublicIPs field.
      externalName:
        type: string
        description: |
          externalName is the external reference that kubedns or equivalent will return as a CNAME record for this service. No proxying will be involved. Must be a valid DNS name and requires Type to be ExternalName.
      loadBalancerIP:
        type: string
        description: |
          Only applies to Service Type: LoadBalancer LoadBalancer will get created with the IP specified in this field. This feature depends on whether the underlying cloud-provider supports specifying the loadBalancerIP when a load balancer is created. This field will be ignored if the cloud-provider does not support the feature.
      loadBalancerSourceRanges:
        type: string
        description: |
          array  If specified and supported by the platform, this will restrict traffic through the cloud-provider load-balancer will be restricted to the specified client IPs. This field will be ignored if the cloud-provider does not support the feature." More info: http://kubernetes.io/docs/user-guide/services-firewalls
      ports:
        type: list
        description: |
          The list of ports that are exposed by this service. More info: http://kubernetes.io/docs/user-guide/services#virtual-ips-and-service-proxies
        entry_schema:
          type: org.alien4cloud.extended.container.data.ServicePort
      selector:
        type: map
        description: |
          Route service traffic to pods with label keys and values matching this selector. If empty or not present, the service is assumed to have an external process managing its endpoints, which Kubernetes will not modify. Only applies to types ClusterIP, NodePort, and LoadBalancer. Ignored if type is ExternalName. More info: http://kubernetes.io/docs/user-guide/services#overview
      sessionAffinity:
        type: string
        description: |
          Supports "ClientIP" and "None". Used to maintain session affinity. Enable client IP based session affinity. Must be ClientIP or None. Defaults to None. More info: http://kubernetes.io/docs/user-guide/services#virtual-ips-and-service-proxies
      type:
        type: string
        description: |
          type determines how the Service is exposed. Defaults to ClusterIP. Valid options are ExternalName, ClusterIP, NodePort, and LoadBalancer. "ExternalName" maps to the specified externalName. "ClusterIP" allocates a cluster-internal IP address for load-balancing to endpoints. Endpoints are determined by the selector or if that is not specified, by manual construction of an Endpoints object. If clusterIP is "None", no virtual IP is allocated and the endpoints are published as a set of endpoints rather than a stable IP. "NodePort" builds on ClusterIP and allocates a port on every node which routes to the clusterIP. "LoadBalancer" builds on NodePort and creates an external load-balancer (if supported in the current cloud) which routes to the clusterIP. More info: http://kubernetes.io/docs/user-guide/services#overview
        constraints:
          valid_values: [ 'ExternalName', 'ClusterIP', 'NodePort', 'LoadBalancer' ]

  org.alien4cloud.extended.container.data.DeploymentSpec:
    derived_from: tosca.datatypes.Root
    description: >
      c.f. https://kubernetes.io/docs/api-reference/v1.6/#deploymentspec-v1beta1-apps
    properties:
      minReadySeconds:
        type: integer
        descriptions: |
          Minimum number of seconds for which a newly created pod should be ready without any of its container crashing, for it to be considered available. Defaults to 0 (pod will be considered available as soon as it is ready)
      paused:
        type: boolean
        descriptions: |
          Indicates that the deployment is paused.
      progressDeadlineSeconds:
        type: integer
        descriptions: |
          The maximum time in seconds for a deployment to make progress before it is considered to be failed. The deployment controller will continue to process failed deployments and a condition with a ProgressDeadlineExceeded reason will be surfaced in the deployment status. Once autoRollback is implemented, the deployment controller will automatically rollback failed deployments. Note that progress will not be estimated during the time a deployment is paused. Defaults to 600s.
      replicas:
        type: integer
        descriptions: |
          Number of desired pods. This is a pointer to distinguish between explicit zero and not specified. Defaults to 1.
      revisionHistoryLimit:
        type: integer
        descriptions: |
          The number of old ReplicaSets to retain to allow rollback. This is a pointer to distinguish between explicit zero and not specified. Defaults to 2.
      rollbackTo:
        type: string # datetype: RollbackConfig
        descriptions: |
          The config this deployment is rolling back to. Will be cleared after rollback is done.
      selector:
        type: string # datetype: LabelSelector
        descriptions: |
          Label selector for pods. Existing ReplicaSets whose pods are selected by this will be the ones affected by this deployment.
      strategy:
        type: string # datetype: DeploymentStrategy
        descriptions: |
          The deployment strategy to use to replace existing pods with new ones.
      template:
        type: string # datetype: PodTemplateSpec
        descriptions: |
          Template describes the pods that will be created.


  org.alien4cloud.extended.container.data.PodTemplateSpec:
    derived_from: tosca.datatypes.Root
    description: >
      c.f. hhttps://kubernetes.io/docs/api-reference/v1.6/#podtemplatespec-v1-core
      For instance:
        metadata:
          labels:
            app: nginx
    properties:
      metadata:
        type: string
        descriptions: |
          Standard object's metadata. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#metadata
      spec:
        type: PodSpec
        descriptions: |
          Specification of the desired behavior of the pod. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#spec-and-status


  org.alien4cloud.extended.container.data.PodSpec:
    derived_from: tosca.datatypes.Root
    properties:
      activeDeadlineSeconds:
        type: integer
        descriptions: |
          Optional duration in seconds the pod may be active on the node relative to StartTime before the system will actively try to mark it failed and kill associated containers. Value must be a positive integer.
      affinity:
        type: org.alien4cloud.extended.container.data.Affinity
        descriptions: |
           If specified, the pod's scheduling constraints
      automountServiceAccountToken:
        type: boolean
        descriptions: |
          AutomountServiceAccountToken indicates whether a service account token should be automatically mounted.
      # containers:
      #   type: Container
      #   descriptions: |
      #     array List of containers belonging to the pod. Containers cannot currently be added or removed. There must be at least one container in a Pod. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/containers
      dnsPolicy:
        type: string
        descriptions: |
           Set DNS policy for containers within the pod. One of 'ClusterFirstWithHostNet', 'ClusterFirst' or 'Default'. Defaults to "ClusterFirst". To have DNS options set along with hostNetwork, you have to specify DNS policy explicitly to 'ClusterFirstWithHostNet'.
      hostIPC:
        type: boolean
        descriptions: |
          Use the host's ipc namespace. Optional: Default to false.
      hostNetwork:
        type: boolean
        descriptions: |
          Host networking requested for this pod. Use the host's network namespace. If this option is set, the ports that will be used must be specified. Default to false.
      hostPID:
        type: boolean
        descriptions: |
          Use the host's pid namespace. Optional: Default to false.
      hostname:
        type: string
        descriptions: |
           Specifies the hostname of the Pod If not specified, the pod's hostname will be set to a system-defined value.
      imagePullSecrets:
        type: LocalObjectReference
        descriptions: |
          array  ImagePullSecrets is an optional list of references to secrets in the same namespace to use for pulling any of the images used by this PodSpec. If specified, these secrets will be passed to individual puller implementations for them to use. For example, in the case of docker, only DockerConfig type secrets are honored. More info: http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod
      initContainers:
        type: Container
        descriptions: |
          array List of initialization containers belonging to the pod. Init containers are executed in order prior to containers being started. If any init container fails, the pod is considered to have failed and is handled according to its restartPolicy. The name for an init container or normal container must be unique among all containers. Init containers may not have Lifecycle actions, Readiness probes, or Liveness probes. The resourceRequirements of an init container are taken into account during scheduling by finding the highest request/limit for each resource type, and then using the max of of that value or the sum of the normal containers. Limits are applied to init containers in a similar fashion. Init containers cannot currently be added or removed. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/containers
      nodeName:
        type: string
        descriptions: |
           NodeName is a request to schedule this pod onto a specific node. If it is non-empty, the scheduler simply schedules this pod onto that node, assuming that it fits resource requirements.
      nodeSelector:
        type: object
        descriptions: |
           NodeSelector is a selector which must be true for the pod to fit on a node. Selector which must match a node's labels for the pod to be scheduled on that node. More info: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector
      restartPolicy:
        type: string
        descriptions: |
           Restart policy for all containers within the pod. One of Always, OnFailure, Never. Default to Always. More info: http://kubernetes.io/docs/user-guide/pod-states#restartpolicy
      schedulerName:
        type: string
        descriptions: |
           If specified, the pod will be dispatched by specified scheduler. If not specified, the pod will be dispatched by default scheduler.
      securityContext:
        type: PodSecurityContext
        descriptions: |
           SecurityContext holds pod-level security attributes and common container settings. Optional: Defaults to empty. See type description for default values of each field.
      serviceAccount:
        type: string
        descriptions: |
           DeprecatedServiceAccount is a depreciated alias for ServiceAccountName. Deprecated: Use serviceAccountName instead.
      serviceAccountName:
        type: string
        descriptions: |
           ServiceAccountName is the name of the ServiceAccount to use to run this pod. More info: http://releases.k8s.io/HEAD/docs/design/service_accounts.md
      subdomain:
        type: string
        descriptions: |
           If specified, the fully qualified Pod hostname will be "...svc.". If not specified, the pod will not have a domainname at all.
      terminationGracePeriodSeconds:
        type: integer
        descriptions: |
          Optional duration in seconds the pod needs to terminate gracefully. May be decreased in delete request. Value must be non-negative integer. The value zero indicates delete immediately. If this value is nil, the default grace period will be used instead. The grace period is the duration in seconds after the processes running in the pod are sent a termination signal and the time when the processes are forcibly halted with a kill signal. Set this value longer than the expected cleanup time for your process. Defaults to 30 seconds.
      tolerations:
        type: Toleration
        descriptions: |
          array  If specified, the pod's tolerations. More info: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration
      volumes:
        type: Volume
        descriptions: |
          array  List of volumes that can be mounted by containers belonging to the pod. More info: http://kubernetes.io/docs/user-guide/volumes


  org.alien4cloud.extended.container.data.ContainerSpec:
    derived_from: tosca.datatypes.Root
    properties:
      args:
        type: string
        description: |
          array  Arguments to the entrypoint. The docker image's CMD is used if this is not provided. Variable references $(VAR_NAME) are expanded using the container's environment. If a variable cannot be resolved, the reference in the input string will be unchanged. The $(VAR_NAME) syntax can be escaped with a double $$, ie: $$(VAR_NAME). Escaped references will never be expanded, regardless of whether the variable exists or not. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/containers#containers-and-commands
      command:
        type:string
        description: |
          array  Entrypoint array. Not executed within a shell. The docker image's ENTRYPOINT is used if this is not provided. Variable references $(VAR_NAME) are expanded using the container's environment. If a variable cannot be resolved, the reference in the input string will be unchanged. The $(VAR_NAME) syntax can be escaped with a double $$, ie: $$(VAR_NAME). Escaped references will never be expanded, regardless of whether the variable exists or not. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/containers#containers-and-commands
      env:
        type:EnvVar
        description: |
          array  List of environment variables to set in the container. Cannot be updated.
      envFrom:
        type:EnvFromSource
        description: |
          array List of sources to populate environment variables in the container. The keys defined within a source must be a C_IDENTIFIER. All invalid keys will be reported as an event when the container is starting. When a key exists in multiple sources, the value associated with the last source will take precedence. Values defined by an Env with a duplicate key will take precedence. Cannot be updated.
      image:
        type:string
        description: |
          Docker image name. More info: http://kubernetes.io/docs/user-guide/images
      imagePullPolicy:
        type:string
        description: |
          Image pull policy. One of Always, Never, IfNotPresent. Defaults to Always if :latest tag is specified, or IfNotPresent otherwise. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/images#updating-images
      lifecycle:
        type:Lifecycle
        description: |
          Actions that the management system should take in response to container lifecycle events. Cannot be updated.
      livenessProbe:
        type:Probe
        description: |
          Periodic probe of container liveness. Container will be restarted if the probe fails. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/pod-states#container-probes
      name:
        type:string
        description: |
          Name of the container specified as a DNS_LABEL. Each container in a pod must have a unique name (DNS_LABEL). Cannot be updated.
      ports:
        type:ContainerPort
        description: |
          array List of ports to expose from the container. Exposing a port here gives the system additional information about the network connections a container uses, but is primarily informational. Not specifying a port here DOES NOT prevent that port from being exposed. Any port which is listening on the default "0.0.0.0" address inside a container will be accessible from the network. Cannot be updated.
      readinessProbe:
        type:Probe
        description: |
          Periodic probe of container service readiness. Container will be removed from service endpoints if the probe fails. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/pod-states#container-probes
      resources:
        type:ResourceRequirements
        description: |
          Compute Resources required by this container. Cannot be updated. More info: http://kubernetes.io/docs/concepts/storage/persistent-volumes/#resources
      securityContext:
        type:SecurityContext
        description: |
          Security options the pod should run with. More info: http://releases.k8s.io/HEAD/docs/design/security_context.md
      stdin:
        type:boolean
        description: |
          Whether this container should allocate a buffer for stdin in the container runtime. If this is not set, reads from stdin in the container will always result in EOF. Default is false.
      stdinOnce:
        type:boolean
        description: |
          Whether the container runtime should close the stdin channel after it has been opened by a single attach. When stdin is true the stdin stream will remain open across multiple attach sessions. If stdinOnce is set to true, stdin is opened on container start, is empty until the first client attaches to stdin, and then remains open and accepts data until the client disconnects, at which time stdin is closed and remains closed until the container is restarted. If this flag is false, a container processes that reads from stdin will never receive an EOF. Default is false
      terminationMessagePath:
        type:string
        description: |
          Optional: Path at which the file to which the container's termination message will be written is mounted into the container's filesystem. Message written is intended to be brief final status, such as an assertion failure message. Will be truncated by the node if greater than 4096 bytes. The total message length across all containers will be limited to 12kb. Defaults to /dev/termination-log. Cannot be updated.
      terminationMessagePolicy:
        type:string
        description: |
          Indicate how the termination message should be populated. File will use the contents of terminationMessagePath to populate the container status message on both success and failure. FallbackToLogsOnError will use the last chunk of container log output if the termination message file is empty and the container exited with an error. The log output is limited to 2048 bytes or 80 lines, whichever is smaller. Defaults to File. Cannot be updated.
      tty:
        type:boolean
        description: |
          Whether this container should allocate a TTY for itself, also requires 'stdin' to be true. Default is false.
      volumeMounts:
        type:VolumeMount
        description: |
          array Pod volumes to mount into the container's filesystem. Cannot be updated.
      workingDir:
        type:string
        description: |
          Container's working directory. If not specified, the container runtime's default will be used, which might be configured in the container image. Cannot be updated.

  org.alien4cloud.extended.container.data.Affinity:
    derived_from: tosca.datatypes.Root
    properties:
      # nodeAffinity:
      #   type: NodeAffinity
      #   description: |
      #     Describes node affinity scheduling rules for the pod.
      # podAffinity:
      #   type: PodAffinity
      #   description: |
      #     Describes pod affinity scheduling rules (e.g. co-locate this pod in the same node, zone, etc. as some other pod(s)).
      podAntiAffinity:
        type: org.alien4cloud.extended.container.data.PodAntiAffinity
        description: |
          Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod in the same node, zone, etc. as some other pod(s)).


  org.alien4cloud.extended.container.data.PodAntiAffinity:
    derived_from: tosca.datatypes.Root
    properties:
      preferredDuringSchedulingIgnoredDuringExecution:
        type: list
        entry_schema:
          type: WeightedPodAffinityTerm

  WeightedPodAffinityTerm:
    derived_from: tosca.datatypes.Root
    properties:
      podAffinityTerm:
        type: PodAffinityTerm
          description: |
            A node selector term, associated with the corresponding weight.
      weight:
        type: integer
          description: |
            Weight associated with matching the corresponding nodeSelectorTerm, in the range 1-100.


  PodAffinityTerm:
    derived_from: tosca.datatypes.Root
    properties:
      labelSelector:
        type: LabelSelector
        description: |
          A label query over a set of resources, in this case pods.
      namespaces:
        type: list
        description: |
          namespaces specifies which namespaces the labelSelector applies to (matches against); nil list means "this pod's namespace," empty list means "all namespaces" The json tag here is not "omitempty" since we need to distinguish nil and empty. See https://golang.org/pkg/encoding/json/#Marshal for more details.
        entry_schema:
          type: string
      topologyKey:
        type: string
        description: |
          This pod should be co-located (affinity) or not co-located (anti-affinity) with the pods matching the labelSelector in the specified namespaces, where co-located is defined as running on a node whose value of the label with key topologyKey matches that of any node on which any of the selected pods is running. For PreferredDuringScheduling pod anti-affinity, empty topologyKey is interpreted as "all topologies" ("all topologies" here means all the topologyKeys indicated by scheduler command-line argument --failure-domains); for affinity and for RequiredDuringScheduling pod anti-affinity, empty topologyKey is not allowed.

  LabelSelector:
    derived_from: tosca.datatypes.Root
    properties:
      matchExpressions:
        type: list
        description: |
          matchExpressions is a list of label selector requirements. The requirements are ANDed.
        entry_schema:
          type: LabelSelectorRequirement
      matchLabels:
        type: object
        description: |
          matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels map is equivalent to an element of matchExpressions, whose key field is "key", the operator is "In", and the values array contains only "value". The requirements are ANDed.

  LabelSelectorRequirement:
    derived_from: tosca.datatypes.Root
    properties:
      key:
        type: string
        description: |
          key is the label key that the selector applies to.
      operator:
        type: string
        description: |
          operator represents a key's relationship to a set of values. Valid operators ard In, NotIn, Exists and DoesNotExist.
      values:
        type: list
        description: |
          values is an array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty. This array is replaced during a strategic merge patch.
        entry_schema:
          type: string

  org.alien4cloud.extended.container.data.HorizontalPodAutoscalerScaleTargetRef:
    derived_from: tosca.datatypes.Root
    properties:
      apiVersion:
        type: string
      kind:
        type: string
      name:
        type: string

  org.alien4cloud.extended.container.data.autoscaler.Metric:
    derived_from: tosca.datatypes.Root
    properties:
      type:
        type: string
        constraints:
          - valid_values: [Resource, Pods, Object]

  org.alien4cloud.extended.container.data.autoscaler.MetricResourceResource:
    derived_from: tosca.datatypes.Root
    properties:
      name:
        type: string
      targetAverageUtilization:
        type: integer

  org.alien4cloud.extended.container.data.autoscaler.MetricResource:
    derived_from: org.alien4cloud.extended.container.data.autoscaler.Metric
    properties:
      type:
        type: string
        default: Resource
        constraints:
          - equals: Resource
      resource:
        type: org.alien4cloud.extended.container.data.autoscaler.MetricResourceResource

  org.alien4cloud.extended.container.data.HorizontalPodAutoscalerSpec:
    derived_from: tosca.datatypes.Root
    properties:
      scaleTargetRef:
        type: org.alien4cloud.extended.container.data.HorizontalPodAutoscalerScaleTargetRef
      minReplicas:
        type: integer
      maxReplicas:
        type: integer
      # since we don't manage polymorphism this is a suggestion to manage different kind of metrics
      metrics_ressources:
        type: list
        entry_schema:
          type: org.alien4cloud.extended.container.data.autoscaler.MetricResource
      # 'metrics_ressources' & 'metrics_pod' should finally be merged in a 'metrics' list
      # metrics_pod:
      #   type: list
      #   entry_schema:
      #     type: org.alien4cloud.extended.container.data.autoscaler.MetricPod

node_types:

  # HOWTO: How about relationships and capabilities ?

  org.alien4cloud.extended.container.types.kubernetes.Base:
    abstract: true
    derived_from: tosca.nodes.Root
    description: |
          c.f. https://kubernetes.io/docs/api-reference/v1.6/#deployment-v1beta1-apps
    properties:
      apiVersion:
        type: string
        description: |
          APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#resources
      kind:
        type: string
        description: |
          Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#types-kinds
        constraints:
          - valid_values: [Deployment, Service, HorizontalPodAutoscaler]
      metadata:
        type: ObjectMeta
        description: |
          Standard object metadata.


  org.alien4cloud.extended.container.types.kubernetes.volume.Base:
    abstract: true
    derived_from: tosca.nodes.Root
    description: |
      https://v1-6.docs.kubernetes.io/docs/api-reference/v1.6/#volume-v1-core
    requirements:
      - attachment:
          capability: alien.capabilities.DockerVolumeAttachment
          relationship: alien.relationships.MountDockerVolume
          occurrences: [1, unbounded]
      - host:
          capability: tosca.capabilities.Container
          relationship: tosca.relationships.HostedOn
          occurrences: [0, 1]
    properties:
      name:
        type: string

  org.alien4cloud.extended.container.types.kubernetes.volume.PersistentVolumeClaimVolumeSource:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.volume.Base
    properties:
      claimName:
        type: string
        description: |
          ClaimName is the name of a PersistentVolumeClaim in the same namespace as the pod using this volume. More info: http://kubernetes.io/docs/user-guide/persistent-volumes#persistentvolumeclaims
      readOnly:
        type: boolean
        description: |
          Will force the ReadOnly setting in VolumeMounts. Default false.
        default: false

  org.alien4cloud.extended.container.types.kubernetes.volume.HostPathVolumeSource:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.volume.Base
    properties:
      path:
        type: string
        description: |
          Path of the directory on the host. More info: http://kubernetes.io/docs/user-guide/volumes#hostpath

  org.alien4cloud.extended.container.types.kubernetes.volume.AWSElasticBlockStoreVolumeSource:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.volume.Base
    properties:
      fsType:
        type: string
        description: |
          Filesystem type of the volume that you want to mount. Tip: Ensure that the filesystem type is supported by the host operating system. Examples: "ext4", "xfs", "ntfs". Implicitly inferred to be "ext4" if unspecified. More info: http://kubernetes.io/docs/user-guide/volumes#awselasticblockstore
      partition:
        type: integer
        description: |
          The partition in the volume that you want to mount. If omitted, the default is to mount by volume name. Examples: For volume /dev/sda1, you specify the partition as "1". Similarly, the volume partition for /dev/sda is "0" (or you can leave the property empty).
      readOnly:
        type: boolean
        description: |
          Specify "true" to force and set the ReadOnly property in VolumeMounts to "true". If omitted, the default is "false". More info: http://kubernetes.io/docs/user-guide/volumes#awselasticblockstore
        default: false
      volumeID:
        type: string
        description: |
          Unique ID of the persistent disk resource in AWS (Amazon EBS volume). More info: http://kubernetes.io/docs/user-guide/volumes#awselasticblockstore

  org.alien4cloud.extended.container.types.kubernetes.Service:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.abstract.Service

  org.alien4cloud.extended.container.types.kubernetes.abstract.Service:
    abstract: true
    derived_from: org.alien4cloud.extended.container.types.kubernetes.Base
    description: >
      Represent a kubernetes Service
    capabilities:
      docker_endpoint:
        type: tosca.capabilities.Endpoint
    properties:
      apiVersion:
        type: string
        description: |
          APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#resources
        default: v1
        constraints:
          - equals: v1
      kind:
        type: string
        description: |
          Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#types-kinds
        default: Service
        constraints:
          - equals: Service
      spec:
        type: org.alien4cloud.extended.container.data.ServiceSpec


  org.alien4cloud.extended.container.types.kubernetes.Deployment:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.abstract.Deployment

  org.alien4cloud.extended.container.types.kubernetes.abstract.Deployment:
    abstract: true
    derived_from: org.alien4cloud.extended.container.types.kubernetes.Base
    description: >
      Represent a kubernetes Deployment
    capabilities:
      host: tosca.capabilities.Container
    properties:
      apiVersion:
        type: string
        description: |
          APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#resources
        default: apps/v1beta1
        constraints:
          - equals: apps/v1beta1
      kind:
        type: string
        description: |
          Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#types-kinds
        default: Deployment
        constraints:
          - equals: Deployment
      spec:
        type: org.alien4cloud.extended.container.data.DeploymentSpec

  org.alien4cloud.extended.container.types.kubernetes.HorizontalPodAutoscaler:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.Base
    description: >
      A kubernetes HorizontalPodAutoscaler object
    properties:
      apiVersion:
        type: string
        default: autoscaling/v2alpha1
        constraints:
          - equals: autoscaling/v2alpha1
      kind:
        type: string
        default: HorizontalPodAutoscaler
        constraints:
          - equals: HorizontalPodAutoscaler
      spec:
        type: org.alien4cloud.extended.container.data.HorizontalPodAutoscalerSpec

  org.alien4cloud.extended.container.types.kubernetes.Container:
    derived_from: org.alien4cloud.extended.container.types.kubernetes.abstract.Container

  org.alien4cloud.extended.container.types.kubernetes.abstract.Container:
    abstract: true
    derived_from: org.alien4cloud.extended.container.types.ContainerRuntime
    description: >
      Represent a kubernetes ContainerSpec.
    properties:
      container:
        type: org.alien4cloud.extended.container.data.ContainerSpec

  org.alien4cloud.extended.container.kubernetes.resource.Base:
    abstract: true
    derived_from: tosca.nodes.Root
    description: >
      Represent a kubernetes final resource after node matching (Pod, ReplicaSet or Deployment)
    artifacts:
      type: tosca.artifacts.File
      file: kubernetes/deployment.yaml
      description: A kubernetes file

  org.alien4cloud.extended.container.kubernetes.resource.Deployment:
    abstract: true
    derived_from: org.alien4cloud.extended.container.kubernetes.resource.Base
    interfaces:
      Standard:
        create:
          implementation: kubectl_deployment_wrapper.sh
          description: |
            - filter variable in the artifact file
            - Deploy the deployment onto kubernets
            - Export some informations to expose it as attributes ?

  org.alien4cloud.extended.container.kubernetes.resource.Service:
    abstract: true
    derived_from: org.alien4cloud.extended.container.kubernetes.resource.Base
    attributes:
      ip_address: { get_operation_output: [SELF, Standard, create, IP_ADDRESS] }
      port: { get_operation_output: [SELF, Standard, create, PORT] }
    interfaces:
      Standard:
        create:
          implementation: kubectl_service_wrapper.sh
          description: |
            - Deploy the service onto kubernets
            - Export the service ip_address and port to expose it as attributes


policy_types:
  org.alien4cloud.extended.container.policy.kubernetes.AntiAffinityLabel:
    derived_from: org.alien4cloud.policies.AntiAffinity
    description: >
      c.f. https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity

    # properties:
    #   affinity:
    #     type: org.alien4cloud.extended.container.data.PodAntiAffinity

#
#-------------------------------------------------
# Kubernetes PODS sample with affinity
#-------------------------------------------------
#
# apiVersion: v1
# kind: Pod
# metadata:
#   name: with-pod-affinity
# spec:
#   affinity:
#     podAffinity:
#       requiredDuringSchedulingIgnoredDuringExecution:
#       - labelSelector:
#           matchExpressions:
#           - key: security
#             operator: In
#             values:
#             - S1
#         topologyKey: failure-domain.beta.kubernetes.io/zone
#     podAntiAffinity:
#       preferredDuringSchedulingIgnoredDuringExecution:
#       - weight: 100
#         podAffinityTerm:
#           labelSelector:
#             matchExpressions:
#             - key: security
#               operator: In
#               values:
#               - S2
#           topologyKey: kubernetes.io/hostname
#   containers:
#   - name: with-pod-affinity
#     image: gcr.io/google_containers/pause:2.0
#
  org.alien4cloud.extended.container.policy.kubernetes.AutoscalingPolicy:
    derived_from: tosca.policies.Scaling
    description: >
      c.f. https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/
    properties:
      spec:
        type: org.alien4cloud.extended.container.data.HorizontalPodAutoscalerSpec
